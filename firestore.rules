rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  	match /AccessibilityItems/{accessibilityItemId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Comments/{commentId} {
    	allow read, update, delete:
      	if resource.data.authorId == request.auth.uid

      allow create:
      	if request.auth != null
    }

    match /Dialogues/{dialogueId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Journeys/{journeyId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null

      match /JourneyEvents/{journeyEventId} {
        allow read, write:
          if isEditorOnProduct(get(/databases/$(database)/documents/Journeys/$(journeyId)).data.productId)
      }
    }

    match /Learnings/{learningId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Objectives/{objectiveId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Personas/{personaId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Products/{productId} {
      allow read, update, delete:
      	if resource.data.members[request.auth.uid].type == "editor"

      allow create:
      	if request.auth != null

      match /Huddles/{huddleId} {
        allow read:
          if isEditorOnProduct(productId)

        allow create:
          if request.auth != null

				allow update, delete:
					if resource.data.userId == request.auth.uid
      }
    }

    match /RetrospectiveItems/{retrospectiveItemId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /StoryMapStates/{storyMapStateId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null

      match /Comments/{commentId} {
        allow read, create:
          if isEditorOnProduct(get(/databases/$(database)/documents/StoryMapStates/$(storyMapStateId)).data.productId)

        allow update, delete:
          if resource.data.authorId == request.auth.uid
      }

      match /Histories/{historyId} {
        allow read, write:
          if isEditorOnProduct(get(/databases/$(database)/documents/StoryMapStates/$(storyMapStateId)).data.productId)
      }

      match /Versions/{versionId} {
        allow read, write:
          if isEditorOnProduct(get(/databases/$(database)/documents/StoryMapStates/$(storyMapStateId)).data.productId)
      }
    }

    match /Tasks/{taskId} {
    	allow read, update, delete:
      	if isEditorOnProduct(resource.data.productId)

      allow create:
      	if request.auth != null
    }

    match /Users/{userId} {
    	allow get, create:
      	if request.auth != null

      allow update, delete:
      	if userId == request.auth.uid
    }

    function isEditorOnProduct(productId) {
      let product = get(/databases/$(database)/documents/Products/$(productId));
      return product.data.members[request.auth.uid].type == "editor"
    }
  }
}
